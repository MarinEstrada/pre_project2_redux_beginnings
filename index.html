<!DOCTYPE html>

<html>
    <head>
        <title>Udacity Todos Goals</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
        <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
        <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
        <script src="https://unpkg.com/redux-thunk@2.2.0/dist/redux-thunk.min.js"></script>
    </head>
    <meta charset= "utf-8"/>
    <body>

        <div id='app'></div>

        <script type='text/javascript'>

            //helper function to generate id
            function generatedId() {
                return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
            }

            // App code

            // add variables for listeneres, this avoids posibility of typos
            const ADD_TODO = 'ADD_TODO'
            const REMOVE_TODO = 'REMOVE_TODO'
            const TOGGLE_TODO = 'TOGGLE_TODO'
            const ADD_GOAL = 'ADD_GOAL'
            const REMOVE_GOAL = 'REMOVE_GOAL'
            const RECEIVE_DATA = 'RECEIVE_DATA'

            //action creators

            function addTodoAction (todo){
                return{
                    type: ADD_TODO,
                    todo,
                }
            }

            function removeTodoAction (id){
                return {
                    type: REMOVE_TODO,
                    id,
                }
            }

            function toggleTodoAction(id){
                return{
                    type: TOGGLE_TODO,
                    id,
                }
            }

            function addGoalAction(goal){
                return{
                    type: ADD_GOAL,
                    goal,
                }
            }

            function removeGoalAction(id){
                return{
                    type: REMOVE_GOAL,
                    id,
                }
            }

            function receiveDataAction(todos, goals){
                return{
                    type: RECEIVE_DATA,
                    todos,
                    goals,
                }
            }

            function handleInitialData(){
                return (dispatch) => {
                    //Promise.all() waits until all promises are completed
                    return Promise.all([
                        API.fetchTodos(),
                        API.fetchGoals(),
                    ]).then(([ todos, goals ]) => {
                        dispatch(receiveDataAction(todos, goals))
                    })

                }
            }

            function handleAddTodo(name, callback){
                return (dispatch) => {
                    return API.saveTodo(name)
                        .then((todo) => {
                            dispatch(addTodoAction(todo))
                            callback()
                        })
                        .catch(() => {
                            alert('An error occured! Try again.')
                        })

                }
            }

            function handleDeleteTodo(todo){
                return (dispatch) => {
                    //removes item from UI
                    dispatch(removeTodoAction(todo.id))

                    //need to remove todo item from DB,
                    return API.deleteTodo(todo.id)
                        //if failure to remove, add it back in
                        .catch(() => {
                            dispatch(addTodoAction(todo))
                            alert('An error occured! Try again.')
                        })
                }
            }

            function handleToggleTodo(id){
                return (dispatch) => {
                    dispatch(toggleTodoAction(id))

                    //update item toggle in the DB
                    return API.saveTodoToggle(id)
                        .catch(() => {
                            dispatch(toggleTodoAction(id))
                            alert('An error occured! Try again.')
                        })
                }
            }

            function handleAddGoal(name, callback){
                return (dispatch) => {
                    return API.saveGoal(name)
                        .then((goal) => {
                            dispatch(addGoalAction(goal))
                            callback()
                        })
                        .catch(() =>{
                            alert('An error occured! Try again.')
                        })

                }
            }

            function handleDeleteGoal(goal){
                return(dispatch) => {
                    //removes item from UI
                    dispatch(removeGoalAction(goal.id))

                    //need to remove goal item from DB
                    return API.deleteGoal(goal.id)
                        //if failure to delete, add goal back in
                        .catch(() => {
                            dispatch(addGoalAction(goal))
                            alert('An error occured! Try again.')
                        })
                }
            }

            // edit state by adding action
            // this is a reducer funciton
            // reduces request into a brand new state (must be a pure function)
            function todos(state = [], action) {
                switch(action.type){
                    case ADD_TODO:
                        return state.concat([action.todo])
                    case REMOVE_TODO:
                        return state.filter((todo) => todo.id !== action.id)
                    case TOGGLE_TODO:
                        return state.map((todo) => todo.id === action.id
                            ? Object.assign({}, todo, {complete: !todo.complete} )
                            : todo)
                    case RECEIVE_DATA:
                        return action.todos
                    default:
                        return state
                }
            }

            //goals reducer
            function goals (state = [], action) {
                switch(action.type) {
                    case ADD_GOAL:
                        return state.concat([action.goal])
                    case REMOVE_GOAL:
                        return state.filter((goal) => goal.id !== action.id)
                    case RECEIVE_DATA:
                        return action.goals
                    default:
                        return state
                }
            }

            function loading(state = true, action){
                switch(action.type){
                    case RECEIVE_DATA:
                        return false
                    default:
                        return state
                }
            }

            // adding starting dispatch code

            //Middleware - Checker
            //after action is dispatched, but before it hits reducer/modifies state
            //next = next middleware if one is there, else=dispatch
            const checker = (store) => (next) => (action) => {
                if(
                    action.type === ADD_TODO &&
                    action.todo.name.toLowerCase().includes('bitcoin')
                ){
                    return alert("Nope. That's a bad idea.")
                }else if(
                    action.type === ADD_GOAL &&
                    action.goal.name.toLowerCase().includes('bitcoin')
                ){
                    return alert("Nope. That's a bad idea.")
                }

                return next(action)
            }

            //Middleware - logger
            // shows what action is, and what is new state after action is dispatched
            const logger = (store) => (next) => (action) => {
                console.group(action.type)
                    console.log('the action: ', action)
                    const result = next(action)
                    console.log('the new state: ', action)
                console.groupEnd()
                return result
            }

            // Note, Redux.applyMiddleware is 2nd argument of createStore
            const store = Redux.createStore(Redux.combineReducers({
                todos,
                goals,
                loading,
            }), Redux.applyMiddleware(ReduxThunk.default, checker, logger))

        </script>

        <script type='text/babel'>

            //will take array then map
            //then map over to create list items
            function List(props) {
                return(
                    <ul>
                        {props.items.map((item) =>(
                            <li key={item.id}>
                                <span
                                    onClick={() => props.toggle && props.toggle(item.id)}
                                    style={{textDecoration: item.complete ? 'line-through' : 'none'}}
                                >
                                    {item.name}
                                </span>
                                <button onClick={() => props.remove(item)}>
                                    X
                                </button>
                            </li>
                        ))}
                    </ul>
                )
            }

            class Todos extends React.Component {

                addItem = (e) => {
                    e.preventDefault()

                    this.props.dispatch(handleAddTodo(
                        this.input.value,
                        () => this.input.value = ''
                    ))
                }

                removeItem = (todo) => {
                    this.props.dispatch(handleDeleteTodo(todo))
                }

                toggleItem = (id) => {
                    this.props.dispatch(handleToggleTodo(id))
                }

                render(){
                    return(
                        <div>
                            <h1>Todo List</h1>
                            <input
                                type='text'
                                placeholder='Add Todo'
                                ref={(input) => this.input = input}
                            />
                            <button onClick={this.addItem}>Add Todo</button>
                            <List
                                toggle={this.toggleItem}
                                items={this.props.todos}
                                remove={this.removeItem}
                            />
                        </div>
                    )
                }
            }

            //React Context integration with todos component
            class ConnectedTodos extends React.Component {
                render() {
                    return(
                        <Context.Consumer>
                            {(store) => {
                                const { todos } = store.getState()

                                return <Todos todos={todos} dispatch={store.dispatch} />
                            }}
                        </Context.Consumer>
                    )
                }
            }

            class Goals extends React.Component {

                addItem = (e) => {
                    e.preventDefault()

                    this.props.dispatch(handleAddGoal(
                        this.input.value,
                        () => this.input.value = ''
                    ))

                }

                removeItem = (goal) => {
                    this.props.dispatch(handleDeleteGoal(goal))
                }

                render(){
                    return(
                        <div>
                            <h1>Goals List</h1>
                            <input
                                type='text'
                                placeholder='Add Goal'
                                ref={(input) => this.input = input}
                            />
                            <button onClick={this.addItem}>Add Goal</button>
                            <List
                                items={this.props.goals}
                                remove={this.removeItem}
                            />
                        </div>
                    )
                }
            }

            //React Context integration with goals component
            class ConnectedGoals extends React.Component {
                render() {
                    return(
                        <Context.Consumer>
                            {(store) => {
                                const { goals } = store.getState()

                                return <Goals goals={goals} dispatch={store.dispatch} />
                            }}
                        </Context.Consumer>
                    )
                }
            }

            class App extends React.Component {
                componentDidMount(){
                    const {store} = this.props

                    store.dispatch(handleInitialData())


                    store.subscribe(() => this.forceUpdate())
                }
                render(){

                    const {store} = this.props
                    const {loading} = store.getState()

                    if(loading === true){
                        return <h3>Loading...</h3>
                    }

                    return(
                        <div>
                            <ConnectedTodos />
                            <ConnectedGoals />
                        </div>
                    )
                }
            }

            //Calling presentational component (app) inside of
            //conected component (Context.consumer)
            //This component is responsible for grabbing from Context
            //for App component
            class ConnectedApp extends React.Component {
                render() {
                    return(
                        <Context.Consumer>
                            {(store) => (
                                <App store={store} />
                            )}
                        </Context.Consumer>
                    )
                }
            }

            //createing context object
            const Context = React.createContext()

            //Abstraction of React component: Context.Provider
            //Takes in store as prop, then sets store context
            //by passing down all subcomponents
            //All components wrapped by Provider will receive
            //the store context(ie: sticks store onto context)
            class Provider extends React.Component{
                render() {
                    return(
                        <Context.Provider value={this.props.store}>
                            {this.props.children}
                        </Context.Provider>
                    )
                }
            }

            ReactDOM.render(
                //by wrapping app in our Provider method and passing
                //it the store, we can now grab store in any of our
                //child compmonents of the App
                <Provider store={store}>
                    <ConnectedApp />
                </Provider>,
                document.getElementById('app')
            )
        </script>

    </body>
</html>
